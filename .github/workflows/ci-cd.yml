name: PHP CI/CD Pipeline - Auto GitFlow

on:
  push:
    branches: [ dev, test, prod ]
  pull_request:
    branches: [ dev, test, prod ]

permissions:
  contents: write
  packages: write
  pull-requests: write

jobs:
  # ==================== DEV BRANCH ====================
  # Job 1: Linting sur DEV
  lint-dev:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/dev' && github.event_name == 'push'
    name: üîç Lint Code on DEV

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.2'
        tools: phpcs
        coverage: none
        
    - name: Get Composer Cache Directory
      id: composer-cache
      run: echo "dir=$(composer config cache-files-dir)" >> $GITHUB_OUTPUT
      
    - name: Cache Composer dependencies
      uses: actions/cache@v3
      with:
        path: ${{ steps.composer-cache.outputs.dir }}
        key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
        restore-keys: ${{ runner.os }}-composer-
        
    - name: Install dependencies
      run: composer install --prefer-dist --no-progress

    - name: Run PHP Syntax Check
      run: find . -name "*.php" -not -path "./vendor/*" -not -path "./phpmailer/*" -exec php -l {} \;

    - name: Run PHP_CodeSniffer
      run: |
        if [ -f "phpcs.xml" ]; then
          vendor/bin/phpcs
        else
          vendor/bin/phpcs --standard=PSR12 --extensions=php --ignore=vendor/,phpmailer/ .
        fi

    - name: Run PHP-CS-Fixer (dry-run)
      run: |
        if [ -f "vendor/bin/php-cs-fixer" ]; then
          vendor/bin/php-cs-fixer fix --dry-run --diff --verbose
        else
          echo "‚ö†Ô∏è PHP-CS-Fixer not installed, skipping..."
        fi
      continue-on-error: true

  # Job 2: Auto-merge DEV ‚Üí TEST via PR
  auto-merge-to-test:
    runs-on: ubuntu-latest
    needs: lint-dev
    if: github.ref == 'refs/heads/dev' && github.event_name == 'push'
    name: üîÑ Auto-merge DEV ‚Üí TEST

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Create and Auto-merge PR from dev to test
      env:
        GH_TOKEN: ${{ secrets.PAT_TOKEN }}
      run: |
        # V√©rifier si une PR existe d√©j√†
        EXISTING_PR=$(gh pr list --base test --head dev --json number --jq '.[0].number')
        
        if [ -z "$EXISTING_PR" ]; then
          # Cr√©er une nouvelle PR
          PR_URL=$(gh pr create --base test --head dev --title "üîÑ Auto-sync: dev ‚Üí test" --body "## Synchronisation automatique dev ‚Üí test

          ‚úÖ **Linting passed on dev**
          
          Cette PR a √©t√© automatiquement cr√©√©e et merg√©e par le pipeline CI/CD apr√®s validation du linting sur la branche \`dev\`.
          
          ---
          _Cr√©√©e et merg√©e automatiquement par GitHub Actions_")
          
          echo "‚úÖ PR created: $PR_URL"
          
          # Extraire le num√©ro de la PR
          PR_NUMBER=$(echo $PR_URL | grep -o '[0-9]*$')
        else
          PR_NUMBER=$EXISTING_PR
          echo "Using existing PR #$PR_NUMBER"
        fi
        
        # Attendre un peu pour que GitHub traite la PR
        sleep 5
        
        # Merger la PR automatiquement avec privil√®ges admin (bypass branch protection)
        gh pr merge $PR_NUMBER --merge --admin --delete-branch=false
        echo "‚úÖ PR #$PR_NUMBER merged successfully and auto-synced to test"

  # ==================== TEST BRANCH ====================
  # Job 3: Tests unitaires sur TEST
  run-tests:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/test' && github.event_name == 'push'
    name: üß™ Run Tests on TEST

    strategy:
      matrix:
        php-versions: ['8.1', '8.2', '8.3']

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: ${{ matrix.php-versions }}
        extensions: mbstring, xml, ctype, json, pdo, pdo_mysql
        coverage: xdebug
        tools: composer:v2

    - name: Cache Composer dependencies
      uses: actions/cache@v3
      with:
        path: vendor
        key: ${{ runner.os }}-php-${{ matrix.php-versions }}-${{ hashFiles('**/composer.lock') }}
        restore-keys: ${{ runner.os }}-php-${{ matrix.php-versions }}-

    - name: Install dependencies
      run: composer install --prefer-dist --no-progress
      
    - name: Run PHPUnit tests
      run: |
        if [ -f "phpunit.xml" ] || [ -f "phpunit.xml.dist" ]; then
          vendor/bin/phpunit --testdox --coverage-text --coverage-clover=coverage.xml
        else
          echo "‚úÖ No PHPUnit configuration found, skipping tests"
        fi
      continue-on-error: false

    - name: Upload coverage to Codecov
      if: matrix.php-versions == '8.2'
      uses: codecov/codecov-action@v4
      with:
        file: ./coverage.xml
        flags: unittests
        name: php-${{ matrix.php-versions }}
      env:
        CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}
      continue-on-error: true

    - name: Basic smoke tests
      run: |
        echo "üî• Running smoke tests..."
        php -r "require 'index.php'; echo 'Index loads successfully\n';" || echo "‚ö†Ô∏è Index check skipped"

  # Job 4: Cr√©er PR TEST ‚Üí PROD (sans auto-merge)
  create-pr-to-prod:
    runs-on: ubuntu-latest
    needs: run-tests
    if: github.ref == 'refs/heads/test' && github.event_name == 'push'
    name: üöÄ Create PR TEST ‚Üí PROD

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Create PR from test to prod
      env:
        GH_TOKEN: ${{ secrets.PAT_TOKEN }}
      run: |
        # V√©rifier si une PR existe d√©j√†
        EXISTING_PR=$(gh pr list --base prod --head test --json number --jq '.[0].number')
        
        if [ -z "$EXISTING_PR" ]; then
          # Cr√©er une nouvelle PR
          PR_URL=$(gh pr create --base prod --head test --title "üöÄ Production Release: test ‚Üí prod" --body "## üöÄ D√©ploiement en Production

          ‚úÖ **Tests passed on test**
          
          Cette PR a √©t√© automatiquement cr√©√©e par le pipeline CI/CD apr√®s validation des tests sur la branche \`test\`.
          
          ### ‚úÖ V√©rifications effectu√©es :
          - Tests unitaires pass√©s sur PHP 8.1, 8.2, 8.3
          - Couverture de code g√©n√©r√©e
          - Smoke tests valid√©s
          
          ### ‚ö†Ô∏è Actions requises avant merge :
          - [ ] **Review approfondie du code**
          - [ ] **V√©rification des changements critiques**
          - [ ] **Validation par au moins 1 reviewer**
          - [ ] **Approbation finale pour production**
          
          ### üìã Checklist de d√©ploiement :
          - [ ] Les tests unitaires passent
          - [ ] Aucune r√©gression d√©tect√©e
          - [ ] Documentation √† jour
          - [ ] Pr√™t pour la production
          
          ---
          _Cr√©√©e automatiquement par GitHub Actions_")
          
          echo "‚úÖ PR created: $PR_URL"
        else
          echo "‚ÑπÔ∏è PR already exists: #$EXISTING_PR"
          echo "Updating PR description..."
          gh pr edit $EXISTING_PR --body "## üöÄ D√©ploiement en Production (Updated)

          ‚úÖ **Tests passed on test**
          
          Cette PR a √©t√© mise √† jour automatiquement apr√®s un nouveau push sur \`test\`.
          
          ### ‚úÖ V√©rifications effectu√©es :
          - Tests unitaires pass√©s sur PHP 8.1, 8.2, 8.3
          - Couverture de code g√©n√©r√©e
          - Smoke tests valid√©s
          
          ### ‚ö†Ô∏è Actions requises avant merge :
          - [ ] **Review approfondie du code**
          - [ ] **V√©rification des changements critiques**
          - [ ] **Validation par au moins 1 reviewer**
          - [ ] **Approbation finale pour production**
          
          ### üìã Checklist de d√©ploiement :
          - [ ] Les tests unitaires passent
          - [ ] Aucune r√©gression d√©tect√©e
          - [ ] Documentation √† jour
          - [ ] Pr√™t pour la production
          
          ---
          _Mise √† jour automatique par GitHub Actions le $(date +'%Y-%m-%d %H:%M:%S')_"
        fi

  # ==================== PROD BRANCH ====================
  # Job 5: G√©n√©ration de documentation et release sur PROD
  create-release:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/prod' && github.event_name == 'push'
    name: üì¶ Create Release & Documentation

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.2'
        tools: composer:v2

    - name: Install dependencies
      run: composer install --prefer-dist --no-progress

    - name: Generate phpDocumentor documentation
      run: |
        if [ -f "phpdoc.xml" ] && [ -f "vendor/bin/phpdoc" ]; then
          echo "üìö Generating phpDocumentor documentation..."
          vendor/bin/phpdoc --config=phpdoc.xml
          echo "‚úÖ Documentation generated successfully"
        else
          echo "‚ö†Ô∏è phpDocumentor not configured, skipping..."
        fi
      continue-on-error: true

    - name: Deploy documentation to GitHub Pages
      if: success()
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./docs/api
        destination_dir: api-docs
      continue-on-error: true

    - name: Configure Git
      run: |
        git config user.name "GitHub Actions Bot"
        git config user.email "actions@github.com"

    - name: Create and Push Release Tag
      run: |
        VERSION=$(date +%Y.%m.%d-%H%M%S)
        git tag -a "v$VERSION" -m "üéâ Production release $VERSION"
        git push origin "v$VERSION"
        echo "‚úÖ Created release tag: v$VERSION"
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Production Deployment
      run: |
        echo "üéâ PRODUCTION DEPLOYMENT SUCCESSFUL!"
        echo "üì¶ Version: v$(date +%Y.%m.%d-%H%M%S)"
        echo "üåê Environment: PRODUCTION"
        echo "üìö Documentation: Available on GitHub Pages"
        # Ajoutez ici vos commandes de d√©ploiement r√©elles si n√©cessaire
        # Exemple: ssh deploy@prod-server "cd /var/www && git pull origin prod && php artisan migrate"

  # ==================== PULL REQUESTS ====================
  # Job 6: Validation des PRs
  pr-validation:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    name: ‚úÖ Validate Pull Request

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.2'
        tools: phpcs, composer:v2

    - name: Install dependencies
      run: composer install --prefer-dist --no-progress

    - name: Run PHP Syntax Check
      run: find . -name "*.php" -not -path "./vendor/*" -not -path "./phpmailer/*" -exec php -l {} \;

    - name: Run PHP_CodeSniffer
      run: |
        if [ -f "phpcs.xml" ]; then
          vendor/bin/phpcs
        else
          vendor/bin/phpcs --standard=PSR12 --extensions=php --ignore=vendor/,phpmailer/ .
        fi
      continue-on-error: true

    - name: Run PHPUnit tests
      run: |
        if [ -f "phpunit.xml" ] || [ -f "phpunit.xml.dist" ]; then
          vendor/bin/phpunit --testdox
        else
          echo "‚ö†Ô∏è No PHPUnit configuration found, skipping tests"
        fi
      continue-on-error: true

